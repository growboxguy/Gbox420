<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gbox: readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Gbox420.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gbox
   &#160;<span id="projectnumber">4.20</span>
   </div>
   <div id="projectbrief">Grow box automation and monitoring</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_Gbox420_PicoW_ExternalLibraries_FreeRTOS_Kernel_main_portable_ThirdParty_GCC_ATmega_readme.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">readme </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>ATmegaxxxx</h2>
<p><b>Port for generalised Microchip ATmega architecture</b></p>
<h3>Description</h3>
<p>This port provides a basis for supporting all modern ATmega devices using either the Enhanced Watchdog Timer, or Timer0 (an 8-bit Timer generally available across the whole range).</p>
<p>This initial commit contains the information required to build with System Tick being generated by either the:</p><ul>
<li>Watchdog Timer, or</li>
<li>Timer0 - an 8-bit Timer, or</li>
<li>TimerN - a 16-bit Timer which will be configured by the user.</li>
</ul>
<p>Further commits can add support for 16-bit Timers available on many relevant devices. The availability of these 16-bit Timers is somewhat device specific, and these complex and highly configurable Timers are often used to generate phase correct PWM timing (for example) and they would be wasted as a simple System Tick.</p>
<p>The port also provides support for the 3 byte program counter devices <b>ATmega2560</b> and <b>ATmega2561</b>. Specific to these two devices the <code>EIND</code> register need to be preserved during a context switch. Also, due to a limitation in GCC, the scheduler needs to reside in the lower 128kB of flash for both of these devices. This is achieved by adding the <code>.lowtext</code> section attribute to the function prototype.</p>
<p>To build generic Microchip (AVR) ATmega support the similarities across the family must be considered, and differences respected. Some comments on the strategy follow.</p>
<h3>System Tick</h3>
<p>The Microchip (AVR) ATmega family has limited Timer and Pin capabilities, and is designed to be used in physical applications, controlling hardware with PWM and recognising level and edge voltage changes. It does this mainly through the use of 16-bit Timers (for generating phase correct PWM by up/down counting), and Pins attached to Interrupts. The 8-bit Timers are also attached to Pins, and they can be used for more simple timing tasks, requiring only a single counting direction.</p>
<p>The Timers not attached to Pins (and therefore not impacting the application of the device) are some 16-bit Timers (very device dependent, eg Timer3 on 1284p), The RTC Timer, and the Watch Dog Timer.</p>
<p>The Watch Dog Timer is configured identically across most of the ATmega devices. It comes in two variants. 1. Old style (eg ATmega32) which does not have an Interrupt capability, and hence on these old devices cannot be used as the System Tick. and 2. New style enhanced WDT, which can generate an Interrupt, and is available on every relevant device.</p>
<p>Using the Watch Dog Timer (WDT) to generate the System Tick does not impact its use as a watch dog. It can be configured to generate a System Tick interrupt, and then one period later to Reset the device if the interrupt is not serviced.</p>
<p>Configuration and usage of the WDT is covered in <code>&lt;avr/wdt.h&gt;</code> which was revised in avr-libc 2.0.0.</p>
<p>Two additional WDT functions are provided in <code>port.c</code>, which extend avr-libc functions to enable the WDT Interrupt without enabling Reset <code>wdt_interrupt_enable()</code>, and to enable both the Interrupt and the Reset <code>wdt_interrupt_reset_enable()</code>.</p>
<h3>3 Byte PC Devices</h3>
<p>The ATtiny, ATmega, ATxmega families can optionally support both 3 byte PC and 3 byte RAM addresses. However, focusing on just the ATmega family only two devices have a large Flash requiring them to use 3 byte PC. These are the <b>ATmega2560</b> and <b>ATmega2561</b>. This PR provides support for these two devices in two ways.</p>
<ul>
<li>providing <code><a class="el" href="IAR_2V850ES_2portmacro_8h.html#ad79a8b96e1489f7f0645e8d57360337d">portSAVE_CONTEXT()</a></code> and <code>portRESTORE_CONTEXT</code> saving both the <b>RAMPZ</b> and <b>EIND</b> registers.</li>
<li>providing a <code><a class="el" href="ARMv8M_2non__secure_2portmacrocommon_8h.html#a2921e1c5a1f974dfa01ae44d1f665f14" title="Task function macros as described on the FreeRTOS.org WEB site.">portTASK_FUNCTION_PROTO()</a></code> with the linker attribute <code>.lowtext</code> which is used to ensure that the scheduler and relevant functions remain in the lower 128kB of Flash.</li>
</ul>
<p>For devices which can support <b>XRAM</b> and have the <b>RAMPZ</b> register, this register is also preserved during the context switch.</p>
<h3>Interrupt Nesting</h3>
<p>The ATmega family does not support interrupt nesting, having only one interrupt priority. This means that when the Scheduler is running, interrupts are normally disabled.</p>
<p>When a very time critical process is running, based on microsecond timing generated by one of the Timers, it is important to re-enable interrupts as early as possible in processing a Yield. Fortunately, this is supported through the use of the <code>NO_BLOCK</code> decorator when defining the Interrupt Service Routine.</p>
<p>The <code>NO_BLOCK</code> decorator will enable the global interrupt early in the handling of an ISR (in this case for the Scheduler), and enable interrupts to be nested. Using this method, I've been able to successfully implement an <a href="https://feilipu.me/2015/06/02/goldilocks-analogue-synthesizer/">Audio Synthesiser</a> with less than 83 microseconds for each cycle, whilst still running the Scheduler to handle display and input.</p>
<p>Using <code>NO_BLOCK</code> is optional, and should only be done if a critical Timer should interrupt the Scheduler.</p>
<h3>Heap Management</h3>
<p>Most users of FreeRTOS will choose to manage their own heap using one of the pre-allocated heap management algorithms, but for those that choose to use <code>heap_3.c</code>, the wrappered <code>malloc()</code> method, there is an issue that needs to be addressed.</p>
<p>The avr-libc library assumes that the stack will always be above the heap, and does a check for this when responding to a <code>malloc()</code> request. This is not the case when Tasks are running, as their stack is located in the early allocated heap address ranges which will be below free heap memory, and so the <code>malloc()</code> request will fail even though heap space is available.</p>
<p>To avoid this issue causing <code>pvPort_Malloc()</code> to failing, the user needs to issue this tuning statement BEFORE they use the heap, or use the <code>xTaskCreate()</code> API.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span>( __malloc_heap_end == 0 )</div>
<div class="line">    __malloc_heap_end = (<span class="keywordtype">char</span> *)(RAMEND - __malloc_margin);</div>
</div><!-- fragment --><p> Unfortunately in the repository there is nowhere sensible to include this statement as it should be included early in the <code><a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667" title="Entry point. Loads settings, create tasks and starts FreeRTOS scheduler.">main()</a></code> function.</p>
<p>For devices which can support <b>XRAM</b> the user will need to tune the location of stack and heap according to their own requirements.</p>
<h3>Supported Devices</h3>
<p>ATmega devices with <b>ENHANCED WDT</b> Interrupt capability - will use WDT.</p>
<ul>
<li>ATmega8U2/16U2/32U2 -&gt; 2kB RAM</li>
<li>ATmega16U4/32U4 - Arduino Leonardo -&gt; 2.5kB RAM</li>
<li>ATmega48PB/88PB/168PB/328PB - Arduino Uno -&gt; 2kB RAM</li>
<li>ATmega164PA/324PA/644PA/1284P - Goldilocks -&gt; <b>16kB RAM</b></li>
<li>ATmega324PB -&gt; 2kB RAM</li>
<li>ATmega640/1280/2560/1281/2561 - Arduino Mega -&gt; <b>8kB RAM + XRAM</b></li>
</ul>
<p>ATmega devices without enhanced <b>WDT</b> Interrupt capability - will use a 8-bit or 16-bit Timer.</p>
<ul>
<li>ATmega8A/16A/32A/64A/128A -&gt; 4kB RAM</li>
<li>ATmega165A/165PA/325A/325PA/3250A/3250PA/645A/645P/6450A/6450P -&gt; 4kB RAM</li>
<li>ATmega169A/169PA/329A/329PA/3290A/3290PA/649A/649P/6490A/6490P -&gt; 4kB RAM</li>
<li>ATmega808/809/1608/1609/3208/3209/4808/4809 - megaAVR 0-Series -&gt; 6kB RAM </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
